# 分享会
各位老师，各位同学，大家好！我是来自兰州大学的蒋嵩林。首先对我的实习情况进行简要的介绍。我于2022年1月10日至7月9日期间参与了openEuler社区的开源实习项目，于sig-KIRAN-DESKTOP，Cloud Native，sig-QA，sig-UKUI，sig-OSCourse这五个社区完成了总计6个任务，获得了150积分。

本次演讲分为三个部分，首先是对实习期间完成的任务进行介绍和经验分享，其次对我完成的重点实习任务，也是我整个实习期间分值最大的任务，进行着重讲解。最后是我的心得体会。

下面我将简略介绍一下我实习任务。第一个任务是在QA SIG完成的，分值为10分，主要是对procinfo 软件包进行加固测试。procinfo (process information) 软件包从 /proc 目录里读取相关数据，将数据妥善整理过后输出到标准输出设备。该类任务最主要的特点是使用openEuler社区开放的测试框架mugen编写测试，我的任务测试了procinfo键盘交互的正确性以及输出信息的正确性。

这种QA任务对新手十分友好，因为一般这类任务都是大同小异，你可以参考已有的同类软件的测试项目，了解其实现原理，进而实现自己的东西，因而十分推荐没怎么接触过开源项目的同学入门参加该任务。

第二个任务是在UKUI SIG完成的，分值为20分，为图形化备份工具的引入。备份工具是桌面环境中常用的工具，之前openEuler社区缺少一款高效、易用的图形化备份工具。本次需要引入一款高效、易用、功能完备的图形化备份工具，图形工具相对独立，能够在openEuler的主要桌面环境中使用，支持x86和arm64架构。需要对比目前linux主流平台上的备份工具，选择一款普适性较强，开发者活跃的开源图形化备份工具，并且需要进行不同备份工具的功能和性能对比，给出选择该备份工具的理由，并在openEuler的open build service中编译通过，并在社区建仓，上传至主线和LTS分支，且能在目前openEuler的桌面环境中，即GNOME、UKUI、XFCE、Deepin均可使用。关于任务，我考察了目前主流的比较完善的并且仍在积极维护的图形化备份工具，初步确定了三款：TimeShift，Kbackup以及BackinTime。对功能进行考察，Kbackup主要专注于用户领域文件的日常备份，而TimeShift则仅用于保护系统文件和设置，不包括文档、图片和音乐等用户文件。BackinTime则是集两者功能之大成。性能的话Kbackup与BackinTime无较大差距。所以我最终为openEuler引入了BackInTime。

这种rpm打包任务相对而言也是好上手的，你可以利用搜索引擎进行搜索，网上的教程很多，相关的为openEuler贡献软件包流程的博客文章也有很多可以供参考。且由于openEuler相关软件包体系和CentOS的很像，所以可以查看相关软件包是否已经引入到了CentOS，然后参照软件包引入CentOS时相关的Spec文件进行编写。这类任务也十分推荐新手参加，可以帮助你快速掌握软件的架构体系。

我的第三个任务是在麒麟信安桌面SIG完成的，分值为30分，主要是适配accountsservice的dbus接口。accountsservice是一个账户管理的后台程序，与kiran-cc-daemon中的accounts插件类似，但一个Linux桌面环境存在两个账户管理后端不利于后续功能的统一管理，因此任务需要能够在麒麟信安的桌面环境中去除掉accountsservice，但由于部分的核心组件，例如lightdm默认是调用accountsservice的dbus接口来获取账户信息的，如果移除掉accountsservice，必须有其它的后端服务能够提供类似的dbus接口，其中的一种解决方案是在kiran-cc-daemon中的accounts插件中添加一个适配器模块来实现ccountsservice提供的所有接口，这些接口的内部实现是将dbus的调用请求转到kiran-cc-daemon中去。任务通过在accounts插件中添加一个适配器模块来完成该解决方案。任务产出标准是，移除掉accountsservice后，登录器跟之前一样正常使用。由于kiran-cc-daemon基于glib的C++库进行开发，需要了解glibmm/giomm以及dbus相关知识。

这个任务的话，如果了解相关技术，就可以完成任务，不了解的话可能会有点难度，所以对于该任务没有太多可以分享的经验。

第四个任务是在云原生SIG完成的，分值也为30分，为calico云原生组件容器镜像制作。容器有不可改变性和可移植性。容器把应用的可执行文件、依赖文件及操作系统文件等打包成镜像，使应用的运行环境固定下来不再变化；同时，镜像可在其他环境下重现同样的运行环境。这些特性给运维和应用的发布带来极大的便利，这要归功于封装应用的镜像。云原生应用(如k8s)容器镜像是云原生基础设施中重要的一环。Calico作为用于K8s的CNI插件时，共涉及到4个组件。由于src-openeuler无相关应用组件仓库，所以先建仓引入该包之后再制作容器镜像。任务需要基于openEuler21.09基础镜像制作出同时支持x86和 arm64两种架构的应用镜像，提交Dockerfile，推送镜像到镜像仓库。

这个任务，由于同类型任务都是需要将原镜像的基底更改为openEuler，所以可以参考官方原镜像的实现，找出运行需要的依赖和条件，并且力求镜像体积最小化。打包相关的经验刚刚已经在第二个任务里说过，这里不再重复。任务最主要的进行测试，可以使用相关云平台服务搭建K8s集群来有针对性地进行测试，从而验证正确性。

第五个任务和上一个任务为同类任务，分值为10分，只不过由calico改为了coredns，并且openEuler包管理器已经引入了coredns，所以直接制作容器镜像就可以。具体经验分享和上一个任务一样，不再重复。

第六个任务，也是我的重点实习任务，是在OSCourse sig完成的，分值为50分，任务内容是为 Rust 工具 mdbook 实现 PDF 格式输出功能，指导老师是马全一。mdbook 是 Rust 语言开发的命令行工具，可以帮助开发者利用 Markdown 格式编写在线书籍。目前 mdbook 能够生成托管的网页，计划为 mdbook 提供 PDF 输出功能，在执行 mdbook build 的命令时，根据配置项在 book 目录下生成 PDF 文件。需要支持x86和arm64 (苹果的m1)架构，并且是完整功能实现，在 mac（m1）、Linux 大多数发型版和 windows 上都可以跑，包含一定的测试用例，选择的依赖是通用的，尽量使用 Pure Rust 的 crates 实现，减少对编译环境的依赖，并且输出标准的 PDF 文件，支持中文。最终还支持自定义PDF纸张方向、页面缩放比例、纸张宽度和高度、页面边距、生成的PDF页面范围、是否显示页眉和页脚以及自定义其格式。

mdBook 支持使用自定义后端，当调用 mdbook build 命令时，假如书籍目录中的book.toml除了默认存在的 [output.html] 生成html网页端外，还存在 [output.pdf] 项，则会在系统PATH中调用mdbook-pdf，同时该程序标准输入中传入相关书籍信息以及参数配置。本程序使用Rust编写，根据上述原理基于headless chrome和Chrome开发工具协议，调用 Google Chrome / Chromium / Microsoft Edge 浏览器打开mdBook后端生成的网站中的 print.html 生成PDF，由于是 headless 模式，运行时浏览器都在后台进行相应操作，无需图形界面，即使有图形界面也不会看到浏览器界面，无感知。

因为headless chrome上游现在自动下载 Chromium 功能还不可用，因而现在某些情况下需要手动下载相关浏览器，即可正常使用。待后续如果上游修复了自动下载 Chromium 功能，将会同步更新，到时候用户将不用管任何东西直接运行即可。

目前在Windows 10及以上该程序无需安装任何额外软件即可正常生成 PDF，因为 Microsoft Edge 是 Windows 系统自带的浏览器。当然如果考虑到对没有自带安装 Edge 的老版本Windows的支持，在电脑上安装一个 Google Chrome 即可。
目前，在 macOS 中需要下载并安装 Google Chrome。
目前，在 Linux 中安装Google Chrome / Chromium / Microsoft Edge 浏览器中的任意一个即可，推荐安装 Chromium，该软件包在您的发行版中一般名称为 chromium 或 chromium-browser

一开始在和马老师沟通的时候，由于一些markdown转latex再转pdf的依赖过于复杂，并且我们确立了不重复造轮子的目标，即不去重复实现CommonMark Spec标准这一mdbook已有的功能，所以我产生了使用mdbook生成的html转pdf的想法。 同时，由于wkhtmltopdf生成的pdf过于简陋，进一步，确立使用浏览器直接导出pdf的目标。操控浏览器主要有使用WebDriver和Chrome开发工具协议两种方案。

随后放弃了的WebDriver方案，虽然WebDriver方案增加了对 Firefox 的支持，但是由于一般WebDriver和浏览器版本之间是相互对应的，用户需要手动查询浏览器版本，下载对应的 WebDriver，不如直接安装浏览器来的方便快捷。而且使用WebDriver打印生成PDF文件时存在一个重大的缺陷，遇到稍微大一点规模的文档时会由于页面崩溃导致生成失败，Chrome 和 Firefox 对应的WebDriver都同时存在这个问题。 此外 WebDriver提供的可自定义打印 PDF 参数选项也相较而言不够多。

最终使用 Chrome开发工具协议 直接和 headless 状态下基于 Chromium 的浏览器直接交互。Rust Crate headless chrome 是Chrome开发工具团队维护的Node JS 库 Puppeteer 的 纯 Rust 实现，但是对于生成大的 PDF 文件的稳定性还不够，容易报超时错误，因而我通过 fork 该 Crate 仓库打补丁的方式，取消了超时限制， 同时增加了对调用Edge生成的支持。在补丁之后使用该 Crate 都能十分顺利地生成 PDF，且在同样的测试环境下也没遇到 WebDriver 下类似的崩溃错误。

测试的话是使用GitHub Actions进行CI/CD，以rust相关书籍来进行测试，以能否成功生成PDF文档为判断标准。目前所有上述书籍的PDF版本文档在x86_64 的 Linux，Windows，macOS 即使是无桌面环境下都可以正常生成

我的实习任务全部介绍完毕，接下来是参与此次开源实习的心得体会与收获。本次开源实习锻炼了我的团队协作和沟通能⼒，拓宽了我的视野，收获丰厚。项目进行期间，openEuler的导师们都给了我许多指导性的意见。所以如果你对开源有足够的热情，想提升自己的技术水平，推荐你参加openEuler开源实习！

最后是经验总结，也是给新加入实习同学的一些建议，主要有三个六字法宝，设计十分重要，多和导师沟通，善用搜索引擎。首先，我们做开源，不能仅仅是完成眼前的任务，眼光得放长远。一个好的架构设计，规范的代码和文档，完整的测试用例，决定了一个开源项目的生命周期和受欢迎程度，同时也会降低软件的持续维护成本，比如我的重点项目，刚刚也提及了我放弃使用WebDriver，转向Chrome 开发工具协议实现，引起的用户体验的巨大提升，也使得出Bug的可能性大大减少。其次，在项目进程中，建议多和导师沟通，不要闭门造车，参考导师的解决方案，倾听别人的意见，会让你收获很多。最后，遇到BUG，善用搜索引擎，看看别人的解决方法，可以节省很多时间。这也是程序员的一项必备技能了。

我的演讲到此结束，谢谢大家！
